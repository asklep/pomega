<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomega Nöbet Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --pomega: #004085; }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .hero { background: var(--pomega); color: white; padding: 25px; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .search-area { max-width: 450px; margin: -20px auto 20px; padding: 0 15px; }
        .search-input { border-radius: 50px; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 12px 20px; }
        .main-card { background: white; border-radius: 15px; margin: 0 15px 40px; box-shadow: 0 0 20px rgba(0,0,0,0.05); overflow: hidden; }
        .table-responsive { max-height: 70vh; overflow: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 14px; white-space: nowrap; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 10; font-weight: bold; border-right: 3px solid var(--pomega); min-width: 170px; text-align: left; }
        thead th { background: var(--pomega) !important; color: white; position: sticky; top: 0; z-index: 11; font-size: 12px; }
        .n1 { background: #dc3545 !important; color: white; font-weight: bold; border-radius: 4px; padding: 2px 6px; }
        .n2 { background: #ffc107 !important; color: black; font-weight: bold; border-radius: 4px; padding: 2px 6px; }
        .n12 { background: linear-gradient(to right, #dc3545 50%, #ffc107 50%) !important; color: white; border-radius: 4px; padding: 2px 6px; }
        .weekend { background-color: #fff1f1 !important; }
        #loader { padding: 50px; text-align: center; font-weight: bold; color: var(--pomega); }
    </style>
</head>
<body>

<div class="hero">
    <h3 class="fw-bold m-0">POMEGA OCAK 2026</h3>
    <small id="update-stat">Veriler yükleniyor...</small>
</div>

<div class="search-area">
    <input type="text" id="q" class="form-control search-input" placeholder="İsim ara..." onkeyup="filter()">
</div>

<div class="main-card">
    <div id="loader">Tablo Hazırlanıyor... (Eğer uzun sürerse sayfayı yenileyin)</div>
    <div class="table-responsive" id="table-wrap" style="display:none;">
        <table id="nobetTable">
            <thead id="head"></thead>
            <tbody id="body"></tbody>
        </table>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
    // CSV URL - CORS engelini aşmak için proxy kullanımı deniyoruz
    const rawUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTHPuchO7TrhvUmDLHNlEvgX_5Mt8J0L0L0RTERIjaL763MY4Hr3Tt1SWIxkbjgjDoum-N-PyrcO_KC/pub?gid=1602899784&single=true&output=csv';
    
    // Veriyi çekmek için fetch kullanıyoruz (Daha güvenli)
    async function loadData() {
        try {
            const response = await fetch(rawUrl);
            const csvText = await response.text();
            
            Papa.parse(csvText, {
                complete: function(results) {
                    if(results.data && results.data.length > 0) {
                        buildTable(results.data);
                    }
                }
            });
        } catch (error) {
            document.getElementById('loader').innerText = "Veri çekme hatası! Lütfen Google Sheets paylaşım ayarlarını kontrol edin.";
            console.error("Hata:", error);
        }
    }

    function buildTable(data) {
        const head = document.getElementById('head');
        const body = document.getElementById('body');

        // Başlık satırları
        let h = '<tr><th class="sticky-col">PERSONEL</th>';
        for(let j=1; j<=31; j++) {
            let dayNum = data[0][j] || j;
            let dayName = data[1][j] || '';
            let isWk = (dayName.toLowerCase() === 'cmt' || dayName.toLowerCase() === 'paz');
            h += `<th class="${isWk ? 'weekend' : ''}">${dayNum}<br><small>${dayName}</small></th>`;
        }
        head.innerHTML = h + '</tr>';

        // Personel satırları
        let b = '';
        for(let i=2; i<data.length; i++) {
            let name = data[i][0] ? data[i][0].trim() : '';
            if(name === "" || name === "Ocak 26" || name === "rt") continue;

            b += '<tr>';
            b += `<td class="sticky-col">${name}</td>`;
            for(let j=1; j<=31; j++) {
                let val = data[i][j] ? data[i][j].trim() : '';
                let dayName = data[1][j] || '';
                let isWk = (dayName.toLowerCase() === 'cmt' || dayName.toLowerCase() === 'paz');
                
                let badge = val;
                if(val === '1') badge = `<span class="n1">1</span>`;
                else if(val === '2') badge = `<span class="n2">2</span>`;
                else if(val === '12') badge = `<span class="n12">12</span>`;

                b += `<td class="${isWk ? 'weekend' : ''}">${badge}</td>`;
            }
            b += '</tr>';
        }
        body.innerHTML = b;
        document.getElementById('loader').style.display = 'none';
        document.getElementById('table-wrap').style.display = 'block';
        document.getElementById('update-stat').innerText = "Liste Güncel";
    }

    function filter() {
        let val = document.getElementById('q').value.toUpperCase();
        let rows = document.getElementById('body').getElementsByTagName('tr');
        for (let r of rows) {
            let name = r.getElementsByTagName('td')[0].innerText.toUpperCase();
            r.style.display = name.includes(val) ? "" : "none";
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
